<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Tabulador RO ‚Äì Eventos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg-main:#0f172a;
      --bg-surface:#020617;
      --bg-card:#020617;
      --border-soft:#1f2937;
      --text-main:#e5e7eb;
      --text-muted:#9ca3af;
      --accent:#38bdf8;
      --accent-soft:rgba(56,189,248,.15);
      --danger:#f97373;
      --ok:#22c55e;
      --warn:#facc15;
    }
    body.light{
      --bg-main:#f3f4f6;
      --bg-surface:#e5e7eb;
      --bg-card:#ffffff;
      --border-soft:#e5e7eb;
      --text-main:#111827;
      --text-muted:#6b7280;
      --accent:#2563eb;
      --accent-soft:rgba(37,99,235,.12);
      --danger:#dc2626;
      --ok:#16a34a;
      --warn:#ca8a04;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top left,#1e293b 0,var(--bg-main) 45%,#020617 100%);
      color:var(--text-main);
      min-height:100vh;
    }
    .shell{max-width:1200px;margin:0 auto;padding:24px 16px 40px}
    .top-bar{
      display:flex;align-items:flex-start;justify-content:space-between;
      gap:12px;margin-bottom:18px;flex-wrap:wrap;
    }
    .title-block{display:flex;flex-direction:column;gap:4px}
    .title-block h1{margin:0;font-size:26px;font-weight:700;letter-spacing:.03em}
    .title-pill{
      font-size:11px;text-transform:uppercase;letter-spacing:.16em;
      color:var(--accent);background:var(--accent-soft);
      border-radius:999px;padding:2px 10px;display:inline-flex;align-items:center;gap:6px;width:fit-content
    }
    .chip-dot{width:7px;height:7px;border-radius:999px;background:var(--ok);box-shadow:0 0 0 4px rgba(34,197,94,.2)}
    .title-block p{margin:0;font-size:12px;color:var(--text-muted);max-width:900px;line-height:1.35}
    .top-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .btn{
      border-radius:999px;border:1px solid var(--border-soft);
      background:rgba(15,23,42,.7);color:var(--text-main);
      padding:7px 13px;font-size:12px;display:inline-flex;align-items:center;gap:6px;
      cursor:pointer;transition:.15s ease
    }
    body.light .btn{background:var(--bg-card)}
    .btn:hover{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent-soft)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-icon{font-size:14px}
    .chip{
      border-radius:999px;border:1px solid var(--border-soft);
      padding:4px 9px;font-size:11px;color:var(--text-muted);
      display:inline-flex;align-items:center;gap:6px;background:rgba(15,23,42,.6)
    }
    body.light .chip{background:var(--bg-card)}
    .panel{
      background:radial-gradient(circle at top left,rgba(56,189,248,.12),var(--bg-card));
      border-radius:18px;padding:12px 14px 14px;border:1px solid rgba(148,163,184,.25);
      box-shadow:0 18px 40px rgba(15,23,42,.55);margin-bottom:16px
    }
    body.light .panel{background:linear-gradient(145deg,#fff,#f9fafb);box-shadow:0 16px 30px rgba(15,23,42,.12)}
    .panel-header{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:10px;flex-wrap:wrap}
    .panel-tag{font-size:10px;text-transform:uppercase;letter-spacing:.16em;color:var(--accent)}
    .panel-header h3{margin:0;font-size:14px}
    .panel-header p{margin:4px 0 0;font-size:11px;color:var(--text-muted);line-height:1.35;max-width:900px}
    .cards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (max-width:900px){.cards{grid-template-columns:minmax(0,1fr)}}
    .card{
      background:radial-gradient(circle at top left,rgba(56,189,248,.12),var(--bg-card));
      border-radius:16px;padding:12px 14px;border:1px solid rgba(148,163,184,.18);
      box-shadow:0 18px 40px rgba(15,23,42,.5);
      display:flex;flex-direction:column;gap:10px;position:relative;overflow:hidden
    }
    body.light .card{background:linear-gradient(145deg,#fff,#f1f5f9);box-shadow:0 16px 30px rgba(15,23,42,.12)}
    .card::after{
      content:"";position:absolute;inset:0;
      background:radial-gradient(circle at top right,rgba(148,163,184,.35),transparent 55%);
      opacity:.35;pointer-events:none
    }
    .card-inner{position:relative;z-index:1}
    .card-top{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .card-label{font-size:11px;text-transform:uppercase;letter-spacing:.16em;color:var(--text-muted)}
    .card-value{font-size:26px;font-weight:800}
    .pill{
      font-size:10px;border-radius:999px;padding:2px 8px;border:1px solid rgba(148,163,184,.55);
      background:rgba(15,23,42,.55);color:var(--text-muted);white-space:nowrap
    }
    body.light .pill{background:rgba(248,250,252,.95)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .search-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .search-input{
      flex:1;min-width:260px;padding:9px 12px;border-radius:999px;border:1px solid rgba(148,163,184,.45);
      background:rgba(15,23,42,.65);color:var(--text-main);outline:none;font-size:12px
    }
    body.light .search-input{background:rgba(248,250,252,.95);color:var(--text-main)}
    .search-input:focus{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-soft)}
    .table-wrapper{border-radius:14px;overflow:hidden;border:1px solid rgba(148,163,184,.4);background:rgba(15,23,42,.75)}
    body.light .table-wrapper{background:#fff}
    .table-scroll{overflow-x:auto}
    table{width:100%;border-collapse:collapse;font-size:11.5px;min-width:1150px}
    thead{background:linear-gradient(90deg,rgba(56,189,248,.18),rgba(37,99,235,.3));color:#0b1220}
    th,td{padding:7px 8px;border-bottom:1px solid rgba(148,163,184,.35);text-align:left;vertical-align:top}
    tbody tr:hover{background:rgba(148,163,184,.22)}
    body.light tbody tr:hover{background:rgba(191,219,254,.45)}
    tbody tr.selected{outline:2px solid rgba(56,189,248,.45); background:rgba(56,189,248,.10)}
    .status-pill{
      font-size:10px;border-radius:999px;padding:2px 7px;border:1px solid rgba(148,163,184,.7);
      background:rgba(15,23,42,.7);color:var(--text-muted);
      max-width:190px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis
    }
    body.light .status-pill{background:rgba(248,250,252,.95)}
    .grid-2{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);gap:12px}
    @media (max-width:900px){.grid-2{grid-template-columns:minmax(0,1fr)}}
    .field{
      display:flex;flex-direction:column;gap:6px;background:rgba(15,23,42,.35);
      border:1px solid rgba(148,163,184,.25);border-radius:14px;padding:10px 10px 9px
    }
    body.light .field{background:rgba(248,250,252,.9)}
    .field label{font-size:11px;color:var(--text-muted)}
    .field input,.field select,.field textarea{
      width:100%;
      border-radius:12px;border:1px solid rgba(148,163,184,.35);
      background:rgba(15,23,42,.55);color:var(--text-main);
      padding:9px 10px;font-size:12px;outline:none
    }
    body.light .field input, body.light .field select, body.light .field textarea{background:#fff;color:var(--text-main)}
    .field input:focus,.field select:focus,.field textarea:focus{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-soft)}
    .field textarea{min-height:92px;resize:vertical}
    .hint{font-size:11px;color:var(--text-muted)}
    .danger{color:var(--danger)}
    .ok{color:var(--ok)}
    .warn{color:var(--warn)}
    .hide{display:none!important}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  </style>
</head>

<body class="dark">
  <div class="shell">
    <div class="top-bar">
      <div class="title-block">
        <div class="title-pill"><span class="chip-dot"></span>TABULADOR RO ¬∑ EVENTOS</div>
        <h1>Registro de follow-up por evento</h1>
        <p id="subtitle">
          Fonte base: <b>dados.csv</b> (Dashboard) ¬∑ Sa√≠da: <b>registros.csv</b> (Tabulador).
          Selecione o evento (Ult Sts) e registre o andamento. O Dashboard pode ‚Äúpuxar‚Äù automaticamente o overlay de registros.
        </p>
      </div>

      <div class="top-actions">
        <button class="btn" id="themeToggle">
          <span class="btn-icon">üåô</span>
          <span class="mode-label">Tema escuro</span>
        </button>
        <button class="btn" id="btnConfig">
          <span class="btn-icon">üîë</span>
          Token GitHub
        </button>
        <span class="chip">
          <span class="chip-dot"></span>
          Vinculado ao Dashboard
        </span>
      </div>
    </div>

    <!-- HOME (EVENTOS) -->
    <div class="panel" id="homePanel">
      <div class="panel-header">
        <div>
          <div class="panel-tag">Eventos</div>
          <h3>Escolha o evento para entrar</h3>
          <p>Mostra quantos ROs existem no <b>Evento 1</b> (Ult Sts = 1) e no <b>Evento 2</b> (Ult Sts = 2). Ao entrar, voc√™ ver√° o tabulador em cima e o detalhamento (lista de ROs) embaixo.</p>
        </div>
        <div class="row">
          <span class="pill">Carregado: <span id="loadState" class="mono">‚Äî</span></span>
        </div>
      </div>

      <div class="cards">
        <div class="card">
          <div class="card-inner">
            <div class="card-top">
              <div>
                <div class="card-label">Evento 1</div>
                <div class="hint">Ult Sts = 1</div>
              </div>
              <span class="pill">Tabulador + lista</span>
            </div>
            <div class="card-value" id="countEvt1">0</div>
            <div class="row" style="justify-content:flex-start;">
              <button class="btn" id="enterEvt1"><span class="btn-icon">‚û°Ô∏è</span>Entrar no Evento 1</button>
            </div>
            <div class="hint">Normalmente Cliente/Produto podem vir em branco ‚Äî voc√™ preenche aqui e fica registrado no overlay.</div>
          </div>
        </div>

        <div class="card">
          <div class="card-inner">
            <div class="card-top">
              <div>
                <div class="card-label">Evento 2</div>
                <div class="hint">Ult Sts = 2</div>
              </div>
              <span class="pill">Tabulador + lista</span>
            </div>
            <div class="card-value" id="countEvt2">0</div>
            <div class="row" style="justify-content:flex-start;">
              <button class="btn" id="enterEvt2"><span class="btn-icon">‚û°Ô∏è</span>Entrar no Evento 2</button>
            </div>
            <div class="hint">Evento do seu Dashboard atual (voc√™ fixou Ult Sts = 2). Aqui voc√™ registra e o Dashboard atualiza se estiver lendo o overlay.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- WORKSPACE -->
    <div class="panel hide" id="workPanel">
      <div class="panel-header">
        <div>
          <div class="panel-tag">Workspace</div>
          <h3 id="workTitle">Registro de follow-up</h3>
          <p>
            Use o tabulador em cima para registrar. A lista (detalhamento) fica embaixo para voc√™ pesquisar e clicar.
            O campo <b>Qtd FP</b> √© a soma de quantos registros existem para a mesma RO no <b>registros.csv</b>.
          </p>
        </div>
        <div class="row">
          <button class="btn" id="btnVoltar"><span class="btn-icon">‚¨ÖÔ∏è</span>Voltar</button>
          <span class="pill">Evento: <b id="eventoLabel">‚Äî</b></span>
        </div>
      </div>

      <!-- TABULADOR (EM CIMA) -->
      <div class="panel" style="margin-bottom:16px;">
        <div class="panel-header">
          <div>
            <div class="panel-tag">Tabulador</div>
            <h3>Registrar follow-up</h3>
            <p>Selecione uma RO pelo campo <b>N¬∫ RO</b> (lista) ou clique em uma linha no detalhamento embaixo. Depois preencha e clique em <b>Salvar registro</b>.</p>
          </div>
          <div class="row">
            <span class="pill">Status do token: <b id="tokenState" class="warn">n√£o configurado</b></span>
          </div>
        </div>

        <div class="grid-2">
          <div class="field">
            <label>N¬∫ RO (pesquisa principal)</label>
            <input id="f_ro" type="text" placeholder="Digite/Selecione a RO..." list="rosList" autocomplete="off" />
            <datalist id="rosList"></datalist>
          </div>

          <div class="field">
            <label>Cliente (pode vir em branco no Evento 1)</label>
            <input id="f_cliente" type="text" placeholder="Cliente" list="clientesList" autocomplete="off" />
            <datalist id="clientesList"></datalist>
          </div>

          <div class="field">
            <label>Produto (√°rvore/decis√£o: lista fixa)</label>
            <select id="f_produto"></select>
          </div>

          <div class="field">
            <label>Situa√ß√£o Atual RO (√°rvore/decis√£o: lista fixa)</label>
            <select id="f_situacao"></select>
          </div>

          <div class="field">
            <label>Qtd FP (soma de registros nesta RO)</label>
            <input id="f_qtdfp" type="text" placeholder="0" readonly />
            <div class="hint">Calculado pelo <b>registros.csv</b> (quantas vezes voc√™ registrou esse RO).</div>
          </div>

          <div class="field">
            <label>√öltimo FP (data do contato)</label>
            <input id="f_ultfp" type="date" />
            <div class="hint">O Dashboard pode mostrar essa data como ‚Äú√öltimo FP‚Äù.</div>
          </div>

          <div class="field" style="grid-column:1/-1;">
            <label>Coment. Qualidade (observa√ß√µes / andamento)</label>
            <textarea id="f_coment" placeholder="Digite aqui as observa√ß√µes..."></textarea>
          </div>
        </div>

        <div class="row" style="justify-content:space-between;margin-top:12px;">
          <div class="hint" id="saveHint">‚Äî</div>
          <div class="row">
            <button class="btn" id="btnExport"><span class="btn-icon">‚¨áÔ∏è</span>Exportar registros (CSV)</button>
            <button class="btn" id="btnSave"><span class="btn-icon">üíæ</span>Salvar registro</button>
          </div>
        </div>
      </div>

      <!-- DETALHAMENTO (APENAS 1, EMBAIXO) -->
      <div class="panel" style="margin-bottom:0;">
        <div class="panel-header">
          <div>
            <div class="panel-tag">Detalhamento</div>
            <h3>Reclama√ß√µes ‚Äî vis√£o detalhada</h3>
            <p>Pesquise e clique na RO para carregar no tabulador. O overlay mostra <b>Qtd FP</b>, <b>√öltimo FP</b> e <b>Coment.</b> do √∫ltimo registro.</p>
          </div>
          <div class="row">
            <span class="pill">Registros: <b id="resultHint">‚Äî</b></span>
          </div>
        </div>

        <div class="search-row">
          <input id="searchRO" class="search-input" type="search" placeholder="Pesquisar por N¬∫ RO (ou Cliente/Produto/Motivo/Situa√ß√£o)..." autocomplete="off" />
          <button class="btn" id="clearSearch"><span class="btn-icon">‚úñ</span>Limpar</button>
        </div>

        <div class="table-wrapper" style="margin-top:10px;">
          <div class="table-scroll">
            <table id="tabelaRO">
              <thead>
                <tr>
                  <th>N¬∫ RO</th>
                  <th>Cliente</th>
                  <th>Produto</th>
                  <th>Data Abertura</th>
                  <th>Motivo</th>
                  <th>Situa√ß√£o Atual RO</th>
                  <th>Qtd FP (overlay)</th>
                  <th>√öltimo FP (overlay)</th>
                  <th>Coment. Qualidade (overlay)</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL TOKEN -->
    <div id="modal" class="hide" style="position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;padding:16px;">
      <div style="max-width:720px;width:100%;background:radial-gradient(circle at top left,rgba(56,189,248,.12),var(--bg-card));
        border:1px solid rgba(148,163,184,.25);border-radius:18px;box-shadow:0 18px 40px rgba(15,23,42,.55);padding:14px;">
        <div class="panel-header" style="margin-bottom:6px;">
          <div>
            <div class="panel-tag">Configura√ß√£o</div>
            <h3>Token GitHub (para gravar no repo)</h3>
            <p>
              Para o Tabulador conseguir atualizar o arquivo <b>registros.csv</b>, voc√™ precisa gerar um token (Fine-grained PAT) com permiss√£o de <b>Contents: Read and write</b> no repo do Tabulador.
              O token fica salvo no seu navegador (localStorage).
            </p>
          </div>
          <div class="row">
            <button class="btn" id="closeModal"><span class="btn-icon">‚úñ</span>Fechar</button>
          </div>
        </div>

        <div class="grid-2">
          <div class="field">
            <label>GitHub Owner</label>
            <input id="cfg_owner" type="text" />
          </div>
          <div class="field">
            <label>Repo do Tabulador</label>
            <input id="cfg_repo" type="text" />
          </div>
          <div class="field" style="grid-column:1/-1;">
            <label>Token (Fine-grained PAT) ‚Äî N√ÉO compartilhe</label>
            <input id="cfg_token" type="password" placeholder="github_pat_..." />
            <div class="hint">Permiss√µes m√≠nimas: repo (apenas esse repo) + <b>Contents Read/Write</b>.</div>
          </div>
          <div class="field">
            <label>Caminho do arquivo</label>
            <input id="cfg_path" type="text" />
          </div>
          <div class="field">
            <label>Branch</label>
            <input id="cfg_branch" type="text" />
          </div>
        </div>

        <div class="row" style="justify-content:space-between;margin-top:10px;">
          <div class="hint">Dica: se n√£o configurar token, voc√™ ainda pode <b>exportar</b> o CSV e subir manualmente.</div>
          <div class="row">
            <button class="btn" id="btnClearToken"><span class="btn-icon">üßπ</span>Limpar token</button>
            <button class="btn" id="btnSaveConfig"><span class="btn-icon">‚úÖ</span>Salvar config</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    // =========================
    // CONFIG (AJUSTE AQUI)
    // =========================
    const DASHBOARD_CSV_URL = "https://carloscarneiro1.github.io/Dashboard/dados.csv";

    // Leitura do overlay (raw)
    const REGISTROS_RAW_URL_DEFAULT = "https://raw.githubusercontent.com/carloscarneiro1/TabuladorRO/main/registros.csv";

    // Grava√ß√£o (GitHub API) - valores default (voc√™ pode mudar pelo modal)
    const DEFAULT_GH_OWNER = "carloscarneiro1";
    const DEFAULT_GH_REPO  = "TabuladorRO";
    const DEFAULT_GH_PATH  = "registros.csv";
    const DEFAULT_GH_BRANCH= "main";

    // ‚úÖ LISTAS FIXAS (como voc√™ pediu)
    const PRODUTOS_FIXOS = [
      "JACAREI-LAMINADO",
      "JACAREI-METALIZADO",
      "JACAREI-FLOAT I",
      "JACAREI-FLOAT III",
      "JACAREI-FLOAT V",
      "LAMINADO EXTERNO"
    ];

    const SITUACOES_FIXAS = [
      "Aguardando Cliente",
      "Aguardando Qualidade",
      "Aguardando Laborat√≥rio",
      "Aguardando Laminado",
      "Aguardando Coater",
      "Aguardando Armaz√©m",
      "Aguardando Linha 1",
      "Aguardando Linha 3",
      "Aguardando Linha 5"
    ];

    // =========================
    // ESTADO
    // =========================
    const PTBR = new Intl.NumberFormat("pt-BR");
    const state = {
      dados: [],
      dadosEvento: [],
      dadosByRO: {},
      registros: [],
      registrosByRO: {}, // { ro: {count, lastDateISO, lastDateBR, lastSituacao, lastComent, lastCliente, lastProduto} }
      evento: null,
      filtro: ""
    };

    // =========================
    // HELPERS
    // =========================
    function limparCampo(str){
      if(str == null) return "";
      return String(str).replace("\ufeff","").trim();
    }
    function normTxt(s){
      return String(s || "")
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .toLowerCase().trim();
    }
    function normCol(s){
      if(!s) return "";
      return String(s)
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .toLowerCase()
        .replace(/[^a-z0-9]+/g,"");
    }
    function parseCSVLine(line, delimiter){
      const out = [];
      let cur = "";
      let inQuotes = false;

      for(let i=0; i<line.length; i++){
        const ch = line[i];
        if(ch === '"'){
          const next = line[i+1];
          if(inQuotes && next === '"'){ cur += '"'; i++; }
          else inQuotes = !inQuotes;
          continue;
        }
        if(ch === delimiter && !inQuotes){
          out.push(cur); cur = ""; continue;
        }
        cur += ch;
      }
      out.push(cur);
      return out;
    }
    function isoToBR(iso){
      if(!iso) return "";
      const [y,m,d] = String(iso).split("-");
      if(!y||!m||!d) return "";
      return `${d}/${m}/${y}`;
    }
    function safeCSV(v){
      const s = String(v ?? "");
      if(/[;"\n\r,]/.test(s)){
        return `"${s.replace(/"/g,'""')}"`;
      }
      return s;
    }

    // =========================
    // CONFIG STORAGE
    // =========================
    function loadCfg(){
      const cfg = {
        owner: localStorage.getItem("tabRO_owner") || DEFAULT_GH_OWNER,
        repo: localStorage.getItem("tabRO_repo")  || DEFAULT_GH_REPO,
        path: localStorage.getItem("tabRO_path")  || DEFAULT_GH_PATH,
        branch: localStorage.getItem("tabRO_branch")|| DEFAULT_GH_BRANCH,
        token: localStorage.getItem("tabRO_token") || ""
      };
      return cfg;
    }
    function saveCfg(cfg){
      localStorage.setItem("tabRO_owner", cfg.owner || "");
      localStorage.setItem("tabRO_repo",  cfg.repo  || "");
      localStorage.setItem("tabRO_path",  cfg.path  || "");
      localStorage.setItem("tabRO_branch",cfg.branch|| "");
      localStorage.setItem("tabRO_token", cfg.token || "");
    }

    function setTokenState(){
      const cfg = loadCfg();
      const el = document.getElementById("tokenState");
      if(cfg.token){
        el.textContent = "configurado";
        el.className = "ok";
      }else{
        el.textContent = "n√£o configurado";
        el.className = "warn";
      }
    }

    // =========================
    // LOAD BASE (dados.csv) + REGISTROS
    // =========================
    async function loadAll(){
      document.getElementById("loadState").textContent = "carregando...";
      const baseCSV = await fetch(DASHBOARD_CSV_URL).then(r=>r.text());
      state.dados = parseBaseDados(baseCSV);

      // index por RO
      state.dadosByRO = {};
      state.dados.forEach(r=>{
        if(r?.numeroRO) state.dadosByRO[String(r.numeroRO).trim()] = r;
      });

      const registrosCSV = await fetch(resolveRegistrosRawURL()).then(r=>r.ok ? r.text() : "").catch(()=> "");
      state.registros = parseRegistros(registrosCSV);
      state.registrosByRO = indexRegistros(state.registros);

      const evt1 = state.dados.filter(r => Number(r.ultSts) === 1);
      const evt2 = state.dados.filter(r => Number(r.ultSts) === 2);
      document.getElementById("countEvt1").textContent = PTBR.format(evt1.length);
      document.getElementById("countEvt2").textContent = PTBR.format(evt2.length);

      document.getElementById("loadState").textContent = "ok";
      setTokenState();
    }

    function resolveRegistrosRawURL(){
      const cfg = loadCfg();
      const owner = cfg.owner || DEFAULT_GH_OWNER;
      const repo  = cfg.repo  || DEFAULT_GH_REPO;
      const branch= cfg.branch|| DEFAULT_GH_BRANCH;
      const path  = cfg.path  || DEFAULT_GH_PATH;
      return `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${path}`;
    }

    function parseBaseDados(csv){
      const linhas = csv.split(/\r?\n/).filter(l => l.trim() !== "");
      if(linhas.length < 2) return [];

      const delim = linhas[0].includes(";") ? ";" : ",";
      const headerCols = parseCSVLine(linhas[0], delim).map(limparCampo);
      const headerMap = {};
      headerCols.forEach((h,i)=> headerMap[normCol(h)] = i);

      function idxCol(...nomes){
        for(const n of nomes){
          const k = normCol(n);
          if(k in headerMap) return headerMap[k];
        }
        return -1;
      }
      function get(cols, ...nomes){
        const i = idxCol(...nomes);
        if(i >= 0 && i < cols.length) return limparCampo(cols[i]);
        return "";
      }

      return linhas.slice(1).map(line=>{
        const cols = parseCSVLine(line, delim);

        const cliente      = get(cols, "Cliente") || "";
        const numeroRO     = get(cols, "N¬∫ RO", "NumeroRO", "Numero RO", "RO") || "";
        const dataAbertura = get(cols, "Data Abertura", "Data Abertura RO") || "";

        const produto      = get(cols, "Produto") || "";
        const motivo       = get(cols, "Motivo") || "";
        const situacaoRO   = get(cols, "Situa√ß√£o Atual RO","Situacao Atual RO","Situa√ß√£o RO","Status","Situacao") || "";
        const qtdFP        = get(cols, "Qtd FP","Quantidade FP") || "";
        const ultFP        = get(cols, "√öltimo FP","Ultimo FP","Data √öltimo FP","Data Ultimo FP") || "";

        const ultStsRaw = get(cols, "Ult Sts","UltSts","Ult_Sts","Ult. Sts","Ultimo Status","√öltimo Status");
        const ultSts = (ultStsRaw == null || ultStsRaw === "") ? null : parseInt(String(ultStsRaw).replace(/\D+/g,""), 10);

        if(!numeroRO) return null;
        return { cliente, numeroRO, produto, dataAbertura, motivo, situacaoRO, qtdFP, ultFP, ultSts };
      }).filter(Boolean);
    }

    // registros.csv (overlay)
    // Formato: timestampISO;evento;numeroRO;cliente;produto;situacaoRO;ultFP_iso;coment
    function parseRegistros(csv){
      const txt = (csv || "").trim();
      if(!txt) return [];
      const linhas = txt.split(/\r?\n/).filter(l => l.trim() !== "");
      if(linhas.length < 1) return [];

      const delim = linhas[0].includes(";") ? ";" : ",";
      const header = parseCSVLine(linhas[0], delim).map(limparCampo).map(normCol);
      const isHeader = header.includes("numeroro") || header.includes("timestampiso");
      const dataLines = isHeader ? linhas.slice(1) : linhas;

      return dataLines.map(line=>{
        const c = parseCSVLine(line, delim).map(limparCampo);
        const obj = {
          timestampISO: c[0] || "",
          evento: Number(c[1] || 0),
          numeroRO: c[2] || "",
          cliente: c[3] || "",
          produto: c[4] || "",
          situacaoRO: c[5] || "",
          ultFP_iso: c[6] || "",
          coment: c[7] || ""
        };
        if(!obj.numeroRO) return null;
        return obj;
      }).filter(Boolean);
    }

    function indexRegistros(registros){
      const map = {};
      registros.forEach(r=>{
        const ro = String(r.numeroRO || "").trim();
        if(!ro) return;
        if(!map[ro]){
          map[ro] = {
            count: 0,
            lastDateISO: "",
            lastDateBR: "",
            lastSituacao: "",
            lastComent: "",
            lastCliente: "",
            lastProduto: ""
          };
        }
        map[ro].count += 1;

        const iso = r.ultFP_iso || "";
        const ts  = r.timestampISO || "";
        const kdate = iso || ts;
        const cur = map[ro].lastDateISO || map[ro].lastTS || "";

        if(!cur || (kdate && kdate > cur)){
          map[ro].lastDateISO = iso || map[ro].lastDateISO;
          map[ro].lastTS = kdate;
          map[ro].lastDateBR = iso ? isoToBR(iso) : map[ro].lastDateBR;
          map[ro].lastSituacao = r.situacaoRO || map[ro].lastSituacao;
          map[ro].lastComent   = r.coment || map[ro].lastComent;
          map[ro].lastCliente  = r.cliente || map[ro].lastCliente;
          map[ro].lastProduto  = r.produto || map[ro].lastProduto;
        }
      });
      return map;
    }

    // =========================
    // UI FLOW
    // =========================
    const homePanel = document.getElementById("homePanel");
    const workPanel = document.getElementById("workPanel");

    document.getElementById("enterEvt1").addEventListener("click", ()=> enterEvento(1));
    document.getElementById("enterEvt2").addEventListener("click", ()=> enterEvento(2));
    document.getElementById("btnVoltar").addEventListener("click", ()=> backHome());

    document.getElementById("searchRO").addEventListener("input", (e)=>{
      state.filtro = e.target.value || "";
      renderTabela();
    });
    document.getElementById("clearSearch").addEventListener("click", ()=>{
      state.filtro = "";
      document.getElementById("searchRO").value = "";
      renderTabela();
      document.getElementById("searchRO").focus();
    });

    function backHome(){
      homePanel.classList.remove("hide");
      workPanel.classList.add("hide");
      state.evento = null;
      state.dadosEvento = [];
      clearForm();
    }

    function montarSelectFixos(){
      // Produto (fixo)
      const selProd = document.getElementById("f_produto");
      selProd.innerHTML = "";
      const p0 = document.createElement("option");
      p0.value = "";
      p0.textContent = "Selecione...";
      selProd.appendChild(p0);
      PRODUTOS_FIXOS.forEach(p=>{
        const o = document.createElement("option");
        o.value = p;
        o.textContent = p;
        selProd.appendChild(o);
      });

      // Situa√ß√£o (fixo)
      const selSit = document.getElementById("f_situacao");
      selSit.innerHTML = "";
      const s0 = document.createElement("option");
      s0.value = "";
      s0.textContent = "Selecione...";
      selSit.appendChild(s0);
      SITUACOES_FIXAS.forEach(s=>{
        const o = document.createElement("option");
        o.value = s;
        o.textContent = s;
        selSit.appendChild(o);
      });
    }

    function enterEvento(evt){
      state.evento = evt;
      homePanel.classList.add("hide");
      workPanel.classList.remove("hide");
      document.getElementById("eventoLabel").textContent = `Ult Sts = ${evt}`;
      document.getElementById("workTitle").textContent = `Registro de follow-up (Evento ${evt})`;

      state.dadosEvento = state.dados.filter(r => Number(r.ultSts) === Number(evt));

      // ‚úÖ clientes (do DASH por evento) como sugest√£o
      const clientes = [...new Set(state.dadosEvento.map(r => r.cliente).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
      document.getElementById("clientesList").innerHTML = clientes.map(c => `<option value="${c}"></option>`).join("");

      // ‚úÖ lista de ROs (para selecionar no tabulador sem rolar)
      const ros = [...new Set(state.dadosEvento.map(r => r.numeroRO).filter(Boolean))].sort((a,b)=>String(a).localeCompare(String(b)));
      document.getElementById("rosList").innerHTML = ros.map(ro => `<option value="${ro}"></option>`).join("");

      // ‚úÖ selects fixos
      montarSelectFixos();

      // render
      state.filtro = "";
      document.getElementById("searchRO").value = "";
      renderTabela();
      setTokenState();

      // ao digitar/selecionar RO no input, carregar dados
      document.getElementById("f_ro").onchange = ()=> tryLoadByROInput();
      document.getElementById("f_ro").onblur = ()=> tryLoadByROInput();
    }

    // =========================
    // TABELA + SELE√á√ÉO
    // =========================
    let selectedRO = "";
    function renderTabela(){
      const tbody = document.querySelector("#tabelaRO tbody");
      tbody.innerHTML = "";

      const q = normTxt(state.filtro);
      let base = [...state.dadosEvento];

      if(q){
        base = base.filter(r=>{
          const overlay = state.registrosByRO[r.numeroRO] || null;
          const alvo = [
            r.numeroRO,
            overlay?.lastCliente || r.cliente,
            overlay?.lastProduto || r.produto,
            r.motivo,
            overlay?.lastSituacao || r.situacaoRO
          ].map(normTxt).join(" | ");
          return alvo.includes(q);
        });
      }

      document.getElementById("resultHint").textContent = `${PTBR.format(base.length)} registro(s) no evento ap√≥s filtro`;

      base.forEach(r=>{
        const ro = r.numeroRO || "";
        const overlay = state.registrosByRO[ro] || null;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${ro || "-"}</td>
          <td>${(overlay?.lastCliente || r.cliente || "-")}</td>
          <td>${(overlay?.lastProduto || r.produto || "-")}</td>
          <td>${r.dataAbertura || "-"}</td>
          <td>${r.motivo || "-"}</td>
          <td><span class="status-pill">${(overlay?.lastSituacao || r.situacaoRO || "-")}</span></td>
          <td class="mono">${PTBR.format(overlay?.count || 0)}</td>
          <td>${overlay?.lastDateBR || "-"}</td>
          <td>${overlay?.lastComent ? overlay.lastComent : "-"}</td>
        `;
        tr.addEventListener("click", ()=>{
          document.querySelectorAll("#tabelaRO tbody tr").forEach(x=>x.classList.remove("selected"));
          tr.classList.add("selected");
          loadROtoForm(r);
          // opcional: sobe pro topo (tabulador) ao clicar
          window.scrollTo({ top: 0, behavior: "smooth" });
        });
        tbody.appendChild(tr);
      });
    }

    function tryLoadByROInput(){
      const ro = limparCampo(document.getElementById("f_ro").value);
      if(!ro) return;

      // busca RO dentro do evento atual
      const r = state.dadosEvento.find(x => String(x.numeroRO).trim() === ro);
      if(r){
        loadROtoForm(r);
        return;
      }

      // se n√£o achar, tenta pelo index geral (mas s√≥ preenche o que der)
      const any = state.dadosByRO[ro];
      if(any){
        loadROtoForm(any);
      }
    }

    function loadROtoForm(r){
      selectedRO = r.numeroRO || "";
      const overlay = state.registrosByRO[selectedRO] || null;

      document.getElementById("f_ro").value = selectedRO;

      // cliente/produto: overlay tem prioridade; se vazio no evento1, deixa branco pra preencher
      const cliente = (overlay?.lastCliente || r.cliente || "");
      const produto = (overlay?.lastProduto || r.produto || "");

      document.getElementById("f_cliente").value = cliente;
      document.getElementById("f_produto").value = produto;

      // situa√ß√£o: se overlay tiver, usa. Sen√£o, tenta casar com lista fixa.
      const sit = (overlay?.lastSituacao || r.situacaoRO || "");
      document.getElementById("f_situacao").value = sit;

      document.getElementById("f_qtdfp").value = String(overlay?.count || 0);
      document.getElementById("f_ultfp").value = overlay?.lastDateISO || "";

      document.getElementById("f_coment").value = "";
      document.getElementById("saveHint").textContent = `RO selecionada: ${selectedRO} ¬∑ Evento ${state.evento}`;
    }

    function clearForm(){
      selectedRO = "";
      document.getElementById("f_ro").value = "";
      document.getElementById("f_cliente").value = "";
      document.getElementById("f_produto").value = "";
      document.getElementById("f_situacao").value = "";
      document.getElementById("f_qtdfp").value = "";
      document.getElementById("f_ultfp").value = "";
      document.getElementById("f_coment").value = "";
      document.getElementById("saveHint").textContent = "‚Äî";
    }

    // =========================
    // SAVE (append em registros.csv via GitHub API)
    // =========================
    document.getElementById("btnSave").addEventListener("click", saveRegistro);
    document.getElementById("btnExport").addEventListener("click", exportRegistrosCSV);

    async function saveRegistro(){
      const cfg = loadCfg();
      setTokenState();

      const ro = limparCampo(document.getElementById("f_ro").value);
      if(!ro){
        document.getElementById("saveHint").innerHTML = `<span class="danger">Selecione uma RO primeiro.</span>`;
        return;
      }

      const cliente  = limparCampo(document.getElementById("f_cliente").value);
      const produto  = limparCampo(document.getElementById("f_produto").value);
      const situacao = limparCampo(document.getElementById("f_situacao").value);
      const ultfpISO = limparCampo(document.getElementById("f_ultfp").value); // yyyy-mm-dd
      const coment   = limparCampo(document.getElementById("f_coment").value);

      const timestampISO = new Date().toISOString();
      const evento = Number(state.evento || 0);

      const header = "timestampISO;evento;numeroRO;cliente;produto;situacaoRO;ultFP_iso;coment";
      const newLine = [
        safeCSV(timestampISO),
        safeCSV(evento),
        safeCSV(ro),
        safeCSV(cliente),
        safeCSV(produto),
        safeCSV(situacao),
        safeCSV(ultfpISO),
        safeCSV(coment)
      ].join(";");

      // sem token: orienta export manual
      if(!cfg.token){
        document.getElementById("saveHint").innerHTML =
          `<span class="warn">Token n√£o configurado.</span> Use <b>Exportar registros (CSV)</b> e fa√ßa upload manual do arquivo <b>${cfg.path}</b> no repo <b>${cfg.owner}/${cfg.repo}</b>.`;
        state.registros.push({ timestampISO, evento, numeroRO: ro, cliente, produto, situacaoRO: situacao, ultFP_iso: ultfpISO, coment });
        state.registrosByRO = indexRegistros(state.registros);
        renderTabela();
        document.getElementById("f_qtdfp").value = String(state.registrosByRO[ro]?.count || 0);
        return;
      }

      document.getElementById("btnSave").disabled = true;
      document.getElementById("saveHint").innerHTML = `Salvando no GitHub...`;

      try{
        const apiBase = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${cfg.path}`;
        let currentContent = "";
        let sha = null;

        const getResp = await fetch(`${apiBase}?ref=${encodeURIComponent(cfg.branch)}`,{
          headers:{
            "Authorization": `Bearer ${cfg.token}`,
            "Accept":"application/vnd.github+json"
          }
        });

        if(getResp.status === 200){
          const data = await getResp.json();
          sha = data.sha;
          const decoded = atob((data.content || "").replace(/\n/g,""));
          currentContent = decoded || "";
        }else if(getResp.status === 404){
          currentContent = "";
          sha = null;
        }else{
          const txt = await getResp.text();
          throw new Error(`Falha ao ler arquivo (${getResp.status}): ${txt}`);
        }

        let next = (currentContent || "").trim();
        if(!next){
          next = header + "\n" + newLine + "\n";
        }else{
          const firstLine = next.split(/\r?\n/)[0] || "";
          if(!normTxt(firstLine).includes("numeroro") && !normTxt(firstLine).includes("timestampiso")){
            next = header + "\n" + next + "\n";
          }else{
            next += "\n";
          }
          next += newLine + "\n";
        }

        const putBody = {
          message: `Registro RO ${ro} (Evento ${evento})`,
          content: btoa(unescape(encodeURIComponent(next))),
          branch: cfg.branch
        };
        if(sha) putBody.sha = sha;

        const putResp = await fetch(apiBase,{
          method:"PUT",
          headers:{
            "Authorization": `Bearer ${cfg.token}`,
            "Accept":"application/vnd.github+json",
            "Content-Type":"application/json"
          },
          body: JSON.stringify(putBody)
        });

        if(!putResp.ok){
          const txt = await putResp.text();
          throw new Error(`Falha ao gravar (${putResp.status}): ${txt}`);
        }

        state.registros.push({ timestampISO, evento, numeroRO: ro, cliente, produto, situacaoRO: situacao, ultFP_iso: ultfpISO, coment });
        state.registrosByRO = indexRegistros(state.registros);

        document.getElementById("saveHint").innerHTML = `<span class="ok">Salvo com sucesso!</span> O Dashboard pode refletir essa atualiza√ß√£o assim que ele recarregar o overlay.`;
        document.getElementById("f_qtdfp").value = String(state.registrosByRO[ro]?.count || 0);

        document.getElementById("f_coment").value = "";
        renderTabela();

      }catch(err){
        console.error(err);
        document.getElementById("saveHint").innerHTML = `<span class="danger">Erro:</span> ${String(err.message || err)}`;
      }finally{
        document.getElementById("btnSave").disabled = false;
      }
    }

    function exportRegistrosCSV(){
      const header = "timestampISO;evento;numeroRO;cliente;produto;situacaoRO;ultFP_iso;coment";
      const lines = [header];
      state.registros.forEach(r=>{
        lines.push([
          safeCSV(r.timestampISO),
          safeCSV(r.evento),
          safeCSV(r.numeroRO),
          safeCSV(r.cliente),
          safeCSV(r.produto),
          safeCSV(r.situacaoRO),
          safeCSV(r.ultFP_iso),
          safeCSV(r.coment)
        ].join(";"));
      });
      const blob = new Blob([lines.join("\n") + "\n"], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "registros.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      document.getElementById("saveHint").innerHTML = `<span class="ok">Exportado!</span> Se quiser, suba esse arquivo no repo do Tabulador.`;
    }

    // =========================
    // TEMA
    // =========================
    const themeToggle = document.getElementById("themeToggle");
    function aplicaTemaInicial(){
      const salvo = localStorage.getItem("tabRO_tema");
      if(salvo === "light"){
        document.body.classList.remove("dark"); document.body.classList.add("light");
        themeToggle.querySelector(".btn-icon").textContent = "‚òÄÔ∏è";
        themeToggle.querySelector(".mode-label").textContent = "Tema claro";
      }else{
        document.body.classList.remove("light"); document.body.classList.add("dark");
        themeToggle.querySelector(".btn-icon").textContent = "üåô";
        themeToggle.querySelector(".mode-label").textContent = "Tema escuro";
      }
    }
    aplicaTemaInicial();
    themeToggle.addEventListener("click", ()=>{
      const isDark = document.body.classList.contains("dark");
      if(isDark){
        document.body.classList.remove("dark"); document.body.classList.add("light");
        themeToggle.querySelector(".btn-icon").textContent = "‚òÄÔ∏è";
        themeToggle.querySelector(".mode-label").textContent = "Tema claro";
        localStorage.setItem("tabRO_tema","light");
      }else{
        document.body.classList.remove("light"); document.body.classList.add("dark");
        themeToggle.querySelector(".btn-icon").textContent = "üåô";
        themeToggle.querySelector(".mode-label").textContent = "Tema escuro";
        localStorage.setItem("tabRO_tema","dark");
      }
    });

    // =========================
    // MODAL CONFIG TOKEN
    // =========================
    const modal = document.getElementById("modal");
    document.getElementById("btnConfig").addEventListener("click", ()=>{
      const cfg = loadCfg();
      document.getElementById("cfg_owner").value  = cfg.owner;
      document.getElementById("cfg_repo").value   = cfg.repo;
      document.getElementById("cfg_path").value   = cfg.path;
      document.getElementById("cfg_branch").value = cfg.branch;
      document.getElementById("cfg_token").value  = cfg.token;
      modal.classList.remove("hide");
    });
    document.getElementById("closeModal").addEventListener("click", ()=> modal.classList.add("hide"));
    modal.addEventListener("click",(e)=>{ if(e.target === modal) modal.classList.add("hide"); });

    document.getElementById("btnSaveConfig").addEventListener("click", ()=>{
      const cfg = {
        owner: limparCampo(document.getElementById("cfg_owner").value),
        repo: limparCampo(document.getElementById("cfg_repo").value),
        path: limparCampo(document.getElementById("cfg_path").value),
        branch: limparCampo(document.getElementById("cfg_branch").value),
        token: limparCampo(document.getElementById("cfg_token").value)
      };
      saveCfg(cfg);
      setTokenState();
      modal.classList.add("hide");
      document.getElementById("saveHint").innerHTML = `<span class="ok">Config salva!</span> Recarregue a p√°gina se quiser validar a leitura do overlay pelo raw.`;
    });

    document.getElementById("btnClearToken").addEventListener("click", ()=>{
      const cfg = loadCfg();
      cfg.token = "";
      saveCfg(cfg);
      document.getElementById("cfg_token").value = "";
      setTokenState();
    });

    // init
    loadAll().catch(err=>{
      console.error(err);
      document.getElementById("loadState").textContent = "erro";
      document.getElementById("subtitle").innerHTML =
        `<span class="danger">Erro ao carregar dados:</span> ${String(err.message || err)}<br>` +
        `Confira se o arquivo <b>dados.csv</b> est√° acess√≠vel em: <span class="mono">${DASHBOARD_CSV_URL}</span>`;
    });
  </script>
</body>
</html>
